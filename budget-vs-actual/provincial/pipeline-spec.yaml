budget-vs-actual-provincial:
  title: Provincial budgeted and actual expenditure
  description: Combined dataset which consists of EPRE and ARE of all financial years.
  pipeline:

    ### EPRE 2019-20
    - run: load
      parameters:
        from: 'https://archive.org/download/prvepre201920fromjeffery20190603t14122/PRV%20EPRE%202019-20-from-jeffery-2019-06-03t1412%20%282%29.csv'
        name: epre-2019-20
        format: 'csv'
      cache: true

    - run: set_types
      parameters:
        resources: epre-2019-20
        types:
          Value:
            type: number
            on_error: ignore

    - run: filter
      parameters:
        resources: epre-2019-20
        in:
          - FinancialYear: '2019'
          - BudgetPhase: 'Main Appropriation'

    - run: delete_fields
      parameters:
        resources: epre-2019-20
        fields:
          - VoteNumber
          - SubprogNumber
          - Subprogramme

    - run: join
      parameters:
        source:
          name: epre-2019-20
          key:
            - "Government"
            - "Department"
            - "ProgNumber"
            - "Programme"
            - "FunctionGroup1"
            - "FunctionGroup2"
            - "EconomicClassification1"
            - "EconomicClassification2"
            - "EconomicClassification3"
            - "EconomicClassification4"
            - "EconomicClassification5"
            - "FinancialYear"
            - "BudgetPhase"
          delete: yes
        target:
          name: epre-2019-20
          key: null
        fields:
          "Government": {}
          "Department": {}
          "ProgNumber": {}
          "Programme": {}
          "FunctionGroup1": {}
          "FunctionGroup2": {}
          "EconomicClassification1": {}
          "EconomicClassification2": {}
          "EconomicClassification3": {}
          "EconomicClassification4": {}
          "EconomicClassification5": {}
          "FinancialYear": {}
          "BudgetPhase": {}
          "Value":
            aggregate: sum
        full: true

    ### EPRE 2018-19
    - run: load
      parameters:
        from: 'http://datastore.openspending.org/b9d2af843f3a7ca223eea07fb608e62a/estimates-of-provincial-expenditure-2018-19-uploaded-2019-05-01t1328/final/data/epre-2018-19.csv'
        name: epre-2018-19
        format: 'csv'
      cache: true

    - run: set_types
      parameters:
        resources: epre-2018-19
        types:
          Value:
            type: number
            on_error: ignore

    - run: filter
      parameters:
        resources: epre-2018-19
        in:
          - FinancialYear: '2018'
          - BudgetPhase: 'Main Appropriation'

    - run: delete_fields
      parameters:
        resources: epre-2018-19
        fields:
          - VoteNumber
          - SubprogNumber
          - Subprogramme

    - run: join
      parameters:
        source:
          name: epre-2018-19
          key:
            - "Government"
            - "Department"
            - "ProgNumber"
            - "Programme"
            - "FunctionGroup1"
            - "FunctionGroup2"
            - "EconomicClassification1"
            - "EconomicClassification2"
            - "EconomicClassification3"
            - "EconomicClassification4"
            - "EconomicClassification5"
            - "FinancialYear"
            - "BudgetPhase"
          delete: yes
        target:
          name: epre-2018-19
          key: null
        fields:
          "Government": {}
          "Department": {}
          "ProgNumber": {}
          "Programme": {}
          "FunctionGroup1": {}
          "FunctionGroup2": {}
          "EconomicClassification1": {}
          "EconomicClassification2": {}
          "EconomicClassification3": {}
          "EconomicClassification4": {}
          "EconomicClassification5": {}
          "FinancialYear": {}
          "BudgetPhase": {}
          "Value":
            aggregate: sum
        full: true

    ### EPRE 2017-18
    - run: load
      parameters:
        from: 'https://s3-eu-west-1.amazonaws.com/manual-uploads.vulekamali.gov.za/epre/epre-2017-18-processed-2019-08-26t1020.csv'
        name: 'epre-2017-18'
        format: 'csv'
      cache: true

    - run: set_types
      parameters:
        resources: epre-2017-18
        types:
          Value:
            type: number
            on_error: ignore

    - run: filter
      parameters:
        resources: epre-2017-18
        in:
          - FinancialYear: '2017'
          - BudgetPhase: 'Main Appropriation'

    - run: delete_fields
      parameters:
        resources: epre-2017-18
        fields:
          - VoteNumber
          - SubprogNumber
          - Subprogramme

    - run: join
      parameters:
        source:
          name: epre-2017-18
          key:
            - "Government"
            - "Department"
            - "ProgNumber"
            - "Programme"
            - "FunctionGroup1"
            - "FunctionGroup2"
            - "EconomicClassification1"
            - "EconomicClassification2"
            - "EconomicClassification3"
            - "EconomicClassification4"
            - "EconomicClassification5"
            - "FinancialYear"
            - "BudgetPhase"
          delete: yes
        target:
          name: epre-2017-18
          key: null
        fields:
          "Government": {}
          "Department": {}
          "ProgNumber": {}
          "Programme": {}
          "FunctionGroup1": {}
          "FunctionGroup2": {}
          "EconomicClassification1": {}
          "EconomicClassification2": {}
          "EconomicClassification3": {}
          "EconomicClassification4": {}
          "EconomicClassification5": {}
          "FinancialYear": {}
          "BudgetPhase": {}
          "Value":
            aggregate: sum
        full: true

    ### EPRE 2016-17
    - run: load
      parameters:
        from: 'https://s3-eu-west-1.amazonaws.com/manual-uploads.vulekamali.gov.za/epre/epre-2016-17-processed-2019-08-26t1020.csv'
        name: 'epre-2016-17'
        format: 'csv'
      cache: true

    - run: set_types
      parameters:
        resources: epre-2016-17
        types:
          Value:
            type: number
            on_error: ignore

    - run: filter
      parameters:
        resources: epre-2016-17
        in:
          - FinancialYear: '2016'
          - BudgetPhase: 'Main Appropriation'

    - run: delete_fields
      parameters:
        resources: epre-2016-17
        fields:
          - VoteNumber
          - SubprogNumber
          - Subprogramme

    - run: join
      parameters:
        source:
          name: epre-2016-17
          key:
            - "Government"
            - "Department"
            - "ProgNumber"
            - "Programme"
            - "FunctionGroup1"
            - "FunctionGroup2"
            - "EconomicClassification1"
            - "EconomicClassification2"
            - "EconomicClassification3"
            - "EconomicClassification4"
            - "EconomicClassification5"
            - "FinancialYear"
            - "BudgetPhase"
          delete: yes
        target:
          name: epre-2016-17
          key: null
        fields:
          "Government": {}
          "Department": {}
          "ProgNumber": {}
          "Programme": {}
          "FunctionGroup1": {}
          "FunctionGroup2": {}
          "EconomicClassification1": {}
          "EconomicClassification2": {}
          "EconomicClassification3": {}
          "EconomicClassification4": {}
          "EconomicClassification5": {}
          "FinancialYear": {}
          "BudgetPhase": {}
          "Value":
            aggregate: sum
        full: true

    ### EPRE 2015-16
    - run: load
      parameters:
        from: 'https://s3-eu-west-1.amazonaws.com/manual-uploads.vulekamali.gov.za/epre/epre-2015-16-processed-2019-08-26t1020.csv'
        name: 'epre-2015-16'
        format: 'csv'
      cache: true

    - run: set_types
      parameters:
        resources: epre-2015-16
        types:
          Value:
            type: number
            on_error: ignore

    - run: filter
      parameters:
        resources: epre-2015-16
        in:
          - FinancialYear: '2015'
          - BudgetPhase: 'Main Appropriation'

    - run: delete_fields
      parameters:
        resources: epre-2015-16
        fields:
          - VoteNumber
          - SubprogNumber
          - Subprogramme

    - run: join
      parameters:
        source:
          name: epre-2015-16
          key:
            - "Government"
            - "Department"
            - "ProgNumber"
            - "Programme"
            - "FunctionGroup1"
            - "FunctionGroup2"
            - "EconomicClassification1"
            - "EconomicClassification2"
            - "EconomicClassification3"
            - "EconomicClassification4"
            - "EconomicClassification5"
            - "FinancialYear"
            - "BudgetPhase"
          delete: yes
        target:
          name: epre-2015-16
          key: null
        fields:
          "Government": {}
          "Department": {}
          "ProgNumber": {}
          "Programme": {}
          "FunctionGroup1": {}
          "FunctionGroup2": {}
          "EconomicClassification1": {}
          "EconomicClassification2": {}
          "EconomicClassification3": {}
          "EconomicClassification4": {}
          "EconomicClassification5": {}
          "FinancialYear": {}
          "BudgetPhase": {}
          "Value":
            aggregate: sum
        full: true

    ### ARE 2016-17
    - run: load
      parameters:
        from: 'https://s3-eu-west-1.amazonaws.com/manual-uploads.vulekamali.gov.za/are/are-2016-17-processed-2019-08-26t1500.csv'
        name: 'are-2016-17'
        format: 'csv'
      cache: true

    - run: set_types
      parameters:
        resources: are-2016-17
        types:
          Value:
            type: number
            on_error: ignore

    - run: filter
      parameters:
        resources: are-2016-17
        in:
          - FinancialYear: '2016'
          - BudgetPhase: 'Final Appropriation'
          - BudgetPhase: 'Audit Outcome'

    - run: delete_fields
      parameters:
        resources: are-2016-17
        fields:
          - VoteNumber
          - SubprogNumber
          - Subprogramme

    - run: join
      parameters:
        source:
          name: are-2016-17
          key:
            - "Government"
            - "Department"
            - "ProgNumber"
            - "Programme"
            - "FunctionGroup1"
            - "FunctionGroup2"
            - "EconomicClassification1"
            - "EconomicClassification2"
            - "EconomicClassification3"
            - "EconomicClassification4"
            - "EconomicClassification5"
            - "FinancialYear"
            - "BudgetPhase"
          delete: yes
        target:
          name: are-2016-17
          key: null
        fields:
          "Government": {}
          "Department": {}
          "ProgNumber": {}
          "Programme": {}
          "FunctionGroup1": {}
          "FunctionGroup2": {}
          "EconomicClassification1": {}
          "EconomicClassification2": {}
          "EconomicClassification3": {}
          "EconomicClassification4": {}
          "EconomicClassification5": {}
          "FinancialYear": {}
          "BudgetPhase": {}
          "Value":
            aggregate: sum
        full: true

    ### ARE 2015-16
    - run: load
      parameters:
        from: 'https://s3-eu-west-1.amazonaws.com/manual-uploads.vulekamali.gov.za/are/are-2015-16-processed-2019-08-26t1500.csv'
        name: 'are-2015-16'
        format: 'csv'
      cache: true

    - run: set_types
      parameters:
        resources: are-2015-16
        types:
          Value:
            type: number
            on_error: ignore

    - run: filter
      parameters:
        resources: are-2015-16
        in:
          - FinancialYear: '2015'
          - BudgetPhase: 'Final Appropriation'
          - BudgetPhase: 'Audit Outcome'

    - run: delete_fields
      parameters:
        resources: are-2015-16
        fields:
          - VoteNumber
          - SubprogNumber
          - Subprogramme

    - run: join
      parameters:
        source:
          name: are-2015-16
          key:
            - "Government"
            - "Department"
            - "ProgNumber"
            - "Programme"
            - "FunctionGroup1"
            - "FunctionGroup2"
            - "EconomicClassification1"
            - "EconomicClassification2"
            - "EconomicClassification3"
            - "EconomicClassification4"
            - "EconomicClassification5"
            - "FinancialYear"
            - "BudgetPhase"
          delete: yes
        target:
          name: are-2015-16
          key: null
        fields:
          "Government": {}
          "Department": {}
          "ProgNumber": {}
          "Programme": {}
          "FunctionGroup1": {}
          "FunctionGroup2": {}
          "EconomicClassification1": {}
          "EconomicClassification2": {}
          "EconomicClassification3": {}
          "EconomicClassification4": {}
          "EconomicClassification5": {}
          "FinancialYear": {}
          "BudgetPhase": {}
          "Value":
            aggregate: sum
        full: true

    - run: add_computed_field
      parameters:
        resources:
          - epre-2019-20
          - epre-2018-19
          - epre-2017-18
          - epre-2016-17
          - epre-2015-16
          - are-2016-17
          - are-2015-16
        fields:
          -
            operation: constant
            target: AmountKind
            with: 'Total'

    - run: add_computed_field
      parameters:
        resources:
          - epre-2019-20
          - epre-2018-19
          - epre-2017-18
          - epre-2016-17
          - epre-2015-16
          - are-2016-17
          - are-2015-16
        fields:
        - operation: format
          target: corrected_econ2
          with: '{EconomicClassification1}'

    - run: add_computed_field
      parameters:
        resources:
          - epre-2019-20
          - epre-2018-19
          - epre-2017-18
          - epre-2016-17
          - epre-2015-16
          - are-2016-17
          - are-2015-16
        fields:
        - operation: format
          target: corrected_econ3
          with: '{EconomicClassification2}'

    - run: add_computed_field
      parameters:
        resources:
          - epre-2019-20
          - epre-2018-19
          - epre-2017-18
          - epre-2016-17
          - epre-2015-16
          - are-2016-17
          - are-2015-16
        fields:
        - operation: format
          target: corrected_econ4
          with: '{EconomicClassification3}'

    - run: add_computed_field
      parameters:
        resources:
          - epre-2019-20
          - epre-2018-19
          - epre-2017-18
          - epre-2016-17
          - epre-2015-16
          - are-2016-17
          - are-2015-16
        fields:
        - operation: format
          target: corrected_econ5
          with: '{EconomicClassification4}'

    - run: concatenate
      parameters:
        sources:
          - epre-2019-20
          - epre-2018-19
          - epre-2017-18
          - epre-2016-17
          - epre-2015-16
          - are-2016-17
          - are-2015-16
        target:
          name: budget-vs-actual-provincial
          path: data/budget-vs-actual-provincial.csv
        fields:
          BudgetPhase: ['budget_phase']
          Department: ['department']
          Government: ['government', 'province']
          EconomicClassification1: ['econ1', 'corrected_econ1']
          EconomicClassification2: ['econ2', 'corrected_econ2']
          EconomicClassification3: ['econ3', 'corrected_econ3']
          EconomicClassification4: ['econ4', 'corrected_econ4']
          EconomicClassification5: ['econ5', 'corrected_econ5']
          FunctionGroup1: ['fg1']
          FunctionGroup2: ['fg2']
          ProgNumber: ['ProgNo', 'progno', 'Progno', 'programme_number']
          Programme: ['programme']
          AmountKind: []
          Value: ['value']
          FinancialYear: ['finyear', 'FinYear', 'financial_year']
      cache: false
    - run: dump_to_path
      parameters:
        out-path: './processed'
        format: 'csv'